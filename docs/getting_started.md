# Getting Started

1. [Introduction](#introduction-to-ansible-playbook-bundles-apbs)
1. [Development Environment](#development-environment)
1. [Creating Your First APB](#creating-your-first-apb)
    1. [Init](#using-apb-init)
    1. [Actions](#actions)
        * [Provision](#provision)
        * [Deprovision](#deprovision)
        * [Bind](#bind)
        * [Test](#test)
1. [Notes](#notes)
1. [More Information](#more-information)

## Introduction to Ansible Playbook Bundles (APBs)

In this tutorial, we'll walk through the creation of some sample APBs.  We will create actions for them to allow provision, deprovision, bind, and unbind.  You can find more information about the design of APBs in the [design doc](https://github.com/fusor/ansible-playbook-bundle/blob/master/docs/design.md).  More in-depth information about writing APBs is available in the [developers doc](developers.md)

*Note:  For the remainder of this tutorial, substitute your own information for items marked in brackets, for example `<host>:<port>` might need to be replaced with `172.17.0.1.nip.io:8443`.*

## Development Environment

Before getting started with APBs, we need to get your system set up to create them.

First, make sure your system is properly running [OpenShift Origin](https://www.openshift.org/). You do *not* need to install the Ansible Service Broker + Service Catalog to develop and test APBs in versions `2.0.0` and higher.

Next, install the APB tools as documented in the [APB CLI Tooling doc](https://github.com/automationbroker/apb/blob/master/docs/apb_cli.md#installing-the-apb-tool).  To check, you can run `apb help` and check for a valid response.
```
$ apb help
Tool for working with Ansible Playbook Bundles

Usage:                                                                
  apb [command]
Available Commands:
  binding     Manage bindings
  broker      Interact with an Automation Broker instance
  bundle      Interact with ServiceBundles
  completion  Generates shell completion scripts.
  help        Help about any command
  registry    Configure registry adapters

Flags:
      --config string   configuration file (default is $HOME/.apb)
  -h, --help            help for apb
  -v, --verbose         verbose output

Use "apb [command] --help" for more information about a command.
```

## Creating and testing your first APB
In this tutorial, we'll create an APB for a containerized [hello world application](https://hub.docker.com/r/ansibleplaybookbundle/hello-world/).  We'll work through a basic APB that will mirror the [hello-world-apb](https://github.com/ansibleplaybookbundle/hello-world-apb).

### Initializing APB project
Our first task is to create the skeleton for your app using `ansible-galaxy`.  The command for this is simple:
```bash
$ ansible-galaxy init --type apb my-test-apb
```
At this point you will see the following file structure
```
my-test-apb/
├── apb.yml
├── defaults
│   └── main.yml
├── Dockerfile
├── files
├── handlers
│   └── main.yml
├── Makefile
├── meta
│   └── main.yml
├── playbooks
│   ├── deprovision.yml
│   └── provision.yml
├── README.md
├── tasks
│   └── main.yml
├── templates
├── tests
│   ├── ansible.cfg
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml
```
Two files were created at the root directory, an `apb.yml` and a `Dockerfile`.  These are the minimum required for any APB.  For more information about the apb spec, visit the [developer doc](developers.md#apb-spec-file).  There is also an explanation of what we can do in the [Dockerfile](developers.md#dockerfile).
```yaml
# apb.yml
version: 1.0.0
name: my-test-apb
description: This is a sample application generated by apb init
bindable: False
async: optional
metadata:
  displayName: my-test
plans:
  - name: default
    description: This default plan deploys my-test-apb
    free: True
    metadata: {}
    parameters: []
```
```dockerfile
# Dockerfile
FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\

COPY playbooks /opt/apb/actions
COPY . /opt/ansible/roles/my-test-apb
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
```

We now need to update the `com.redhat.apb.spec` LABEL with a base64 encoded version of apb.yml. To do this we need to run `apb bundle prepare`
```bash
$ cd my-test-apb
$ apb bundle prepare
```

```dockerfile
# Dockerfile
FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IG15LXRlc3QtYXBiCmRlc2NyaXB0aW9uOiBUaGlzIGlzIGEgc2Ft\
cGxlIGFwcGxpY2F0aW9uIGdlbmVyYXRlZCBieSBhcGIgaW5pdApiaW5kYWJsZTogRmFsc2UKYXN5\
bmM6IG9wdGlvbmFsCm1ldGFkYXRhOgogIGRpc3BsYXlOYW1lOiBteS10ZXN0CnBsYW5zOgogIC0g\
bmFtZTogZGVmYXVsdAogICAgZGVzY3JpcHRpb246IFRoaXMgZGVmYXVsdCBwbGFuIGRlcGxveXMg\
bXktdGVzdC1hcGIKICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOiB7fQogICAgcGFyYW1ldGVy\
czogW10="

COPY playbooks /opt/apb/actions
COPY . /opt/ansible/roles/my-test-apb
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
```

### Building and publishing your APB for testing

At this point we have a fully formed APB that we can build. To do this, we leverage the OpenShift build system. To create a `buildconfig` for your APB:
```bash
$ oc new-build . --to <bundle-name>
```

To start the build from the current directory:
```bash
$ oc start-build --from-dir . <bundle-name>
```

At this point, you can check the status of the build:
```bash
$ oc logs -f bc/<bundle-name>
```

When the build is complete, you should see available imagestreams:
```bash
$ oc get is                    
NAME          DOCKER REPO                       TAGS      UPDATED     
apb-base      172.30.1.1:5000/<namespace>/apb-base      latest    4 minutes ago
my-test-apb   172.30.1.1:5000/<namespace>/my-test-apb   latest    3 seconds ago
```

We can now add the internal OpenShift registry to our list of configured registries:
```bash
$ apb registry add my-registry --type local_openshift --namespaces foo
Getting specs for registry: [my-registry]
INFO == REGISTRY CX ==                            
INFO Name: my-registry                            
INFO Type: local_openshift                        
INFO Url:                                         
INFO Validating specs...                          
WARN Spec [  ] failed validation for the following reason: [ Spec [] failed version validation ]. It will not be made available. 
WARN 1 specs of 2 discovered specs failed validation from registry: openshift-registry 
INFO Registry my-registry has 1 valid APBs available from 2 images scanned 
 APB             IMAGE                               REGISTRY    
  ----------- -+- ------------------------------- -+- ----------- 
  my-test-apb  |  172.30.1.1:5000/foo/my-test-apb  |  my-registry 
```

### Running the APB
Now that `apb` is aware of the `my-test-apb` APB in the registry, we can perform any supported action against the APB. The `apb bundle` subcommand gives you some actions you can perform on a specific bundle in a registry.

### More information
* [Design](design.md) - overall design of Ansible Playbook Bundles
* [Developers](developers.md) - in-depth explanation of Ansible Playbook Bundles
* [APB CLI Tool](apb_cli.md) - installation and usage of the `apb` cli tool
* [OpenShift Origin Docs](https://docs.openshift.org/latest/welcome/index.html)
* The [ansible-kubernetes-modules](https://github.com/ansible/ansible-kubernetes-modules) project.
* [Example APBs](https://github.com/fusor/apb-examples)
* [Ansible Service Broker](https://github.com/openshift/ansible-service-broker)
